<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>è´§å¸æ±‡ç‡</title>
    <link href="@{'/public/layui-2.5.5/css/layui.css'}" rel="stylesheet" type="text/css"/>
    <style type="text/css">
        body {
            padding: 20px;
        }

        .layui-table-view .layui-table {
            position: relative;
            width: 100%;
            margin: 0;
        }
    </style>
</head>
<body>
<form class="layui-form layui-form-pane" action="/FinanceMgr/editCurrencyRate" id="currencyRateForm" method="post"
      lay-filter="currencyRateForm" onsubmit="return false;">
    <div class="layui-form-item">
        <label class="layui-form-label">æºè´§å¸</label>
        <div class="layui-input-inline">
            <select lay-filter="sourceCurrency" name="currencyRate.sourceMonetary" id="sourceCurrency"
                    lay-verify="required" lay-search>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">ç›®æ ‡è´§å¸</label>
        <div class="layui-input-inline">
            <select lay-filter="targetCurrency" name="currencyRate.targetMonetary" id="targetCurrency"
                    lay-verify="required" lay-search>
                <option value="31">ä¸­å›½äººæ°‘å¸(CNY)</option>
            </select>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">æ±‡ç‡</label>
        <div class="layui-input-inline">
            <input type="text" name="currencyRate.exchangeRate" id="rate" required lay-verify="rateVerify"
                   placeholder="è¯·è¾“å…¥æ±‡ç‡" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item" style="width: 450px">
        <label class="layui-form-label">æœ‰æ•ˆæœŸ</label>
        <div class="layui-input-block">
            <input type="text" name="validTime" readonly id="validTime" required lay-verify="required"
                   class="layui-input"/>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="submit">ç«‹å³ä¿å­˜</button>
            <button type="reset" class="layui-btn layui-btn-primary">é‡ç½®
            </button>
            <button type="button" id="bttips" lay-filter="bttips" class="layui-btn layui-btn-primary" onclick="tips()">
                æç¤º
            </button>
        </div>
    </div>
</form>
<table class="layui-hide" id="currencyRateTable" lay-filter="currencyRateTable"></table>
</body>
<script type="text/javascript" src="@{'/public/layui-2.5.5/layui.js'}"></script>
<script type="text/javascript">
    // æç¤º
    function tips() {
        layer.tips('ä¸èƒ½åˆ é™¤ï¼Œä¸èƒ½ä¿®æ”¹ï¼Œè¦æƒ³ä¿®æ”¹æ‰¾å¼€å‘ï¼Œæ–°çš„å¼€å§‹æ—¥æœŸå¿…é¡»ä¸ºæœ€è¿‘çš„ç»“æŸæ—¶é—´+1å¤©', '#bttips', {
            tips: [1, '#009688'],
            time: 4000
        });
    }

    // è¡¨æ ¼
    layui.use(['table', 'jquery', 'layer', 'laydate', 'form'], function () {
        var table = layui.table,
            $ = layui.$,
            layer = layui.layer,
            laydate = layui.laydate,
            form = layui.form;

        //æ‰§è¡Œä¸€ä¸ªlaydateå®ä¾‹
        laydate.render({
            elem: '#validTime' //æŒ‡å®šå…ƒç´ 
            , range: '--' // å¼€å¯å·¦å³é¢æ¿èŒƒå›´é€‰æ‹©
            , theme: 'grid'
        });

        // åŠ è½½ç¬¬ä¸€ä¸ªä¸‹æ‹‰æ¡†çš„æ•°æ®
        var htm = '<option value="">ç›´æ¥é€‰æ‹©æˆ–æœç´¢é€‰æ‹©</option>';
        #{list monetaryNames,as:'n'}
        htm += '<option value = "' + ${n.key} +'">${n.value}</option>';
        #{/list}
        $("#sourceCurrency").append(htm);
        form.render();

        // //æ‰§è¡Œä¸€ä¸ª table å®ä¾‹
        var tableReload = table.render({
            elem: '#currencyRateTable'
            , url: '/FinanceMgr/currencyRateItemList' //æ•°æ®æ¥å£
            , page: true //å¼€å¯åˆ†é¡µ
            , toolbar: false //ä¸å¼€å·¥å…·æ äº†ï¼ŒåŸºæœ¬ç”¨ä¸åˆ°è¿™äº›å·¥å…·
            , even: true // éš”è¡ŒèƒŒæ™¯
            , text: "æ— æ•°æ®"
            , cols: [[ //è¡¨å¤´
                {type: 'radio', fixed: 'left', hide: true}
                , {field: 'id', title: 'ID', sort: true, id: "aaa", align: 'center'}
                , {field: 'sourceMonetaryName', sort: true, title: 'æºè´§å¸', align: 'center'}
                , {field: 'targetMonetaryName', sort: true, title: 'ç›®æ ‡è´§å¸', align: 'center'}
                , {field: 'exchangeRate', title: 'æ±‡ç‡', sort: true, align: 'center'}
                , {field: 'startTimeValidTableShow', title: 'æœ‰æ•ˆæœŸå¼€å§‹æ—¶é—´', sort: true, align: 'center'}
                , {field: 'endTimeValidTableShow', title: 'æœ‰æ•ˆæœŸç»“æŸæ—¶é—´', sort: true, align: 'center'}
            ]]
            , response: {
                statusName: 'resultCode' //æ•°æ®çŠ¶æ€çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šcode
                , statusCode: 200 //æˆåŠŸçš„çŠ¶æ€ç ï¼Œé»˜è®¤ï¼š0
                , msgName: 'msg' //çŠ¶æ€ä¿¡æ¯çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šmsg
                , countName: 'totalCount' //æ•°æ®æ€»æ•°çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šcount
                , dataName: 'obj' //æ•°æ®åˆ—è¡¨çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šdata
            }
        });

        //ç›‘å¬è¡Œå•å‡»äº‹ä»¶ï¼ˆå•å‡»äº‹ä»¶ä¸ºï¼šrowDoubleï¼‰
        table.on('row(currencyRateTable)', function (obj) {
            var data = obj.data;
            var form = layui.form;
            //ç»™è¡¨å•èµ‹å€¼
            form.val("currencyRateForm", { // å³ class="layui-form" æ‰€åœ¨å…ƒç´ å±æ€§ lay-filter="" å¯¹åº”çš„å€¼
                "currencyRate.sourceMonetary": data.sourceMonetary // "name": "value"
                , "currencyRate.targetMonetary": data.targetMonetary
                , "currencyRate.exchangeRate": data.exchangeRate
                , "validTime": data.startTimeValidShow + " -- " + data.endTimeValidShow
            });
        });

        // è¡¨æ ¼çš„é‡è½½
        function tableReloadmethod(sourceId, targetId) {
            tableReload.reload({
                where: { //è®¾å®šå¼‚æ­¥æ•°æ®æ¥å£çš„é¢å¤–å‚æ•°ï¼Œä»»æ„è®¾
                    sourceId: sourceId
                    , targetId: targetId
                }
                , page: true
                , response: {
                    statusName: 'resultCode' //æ•°æ®çŠ¶æ€çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šcode
                    , statusCode: 200 //æˆåŠŸçš„çŠ¶æ€ç ï¼Œé»˜è®¤ï¼š0
                    , msgName: 'msg' //çŠ¶æ€ä¿¡æ¯çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šmsg
                    , countName: 'totalCount' //æ•°æ®æ€»æ•°çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šcount
                    , dataName: 'obj' //æ•°æ®åˆ—è¡¨çš„å­—æ®µåç§°ï¼Œé»˜è®¤ï¼šdata
                }
            });
        }

        // ç›‘å¬æºè´§å¸çš„ä¸‹æ‹‰æ¡† çœ‹çœ‹æ‰€é€‰æ‹©çš„å›½å®¶æœ‰æ²¡æœ‰åœ¨æ•°æ®åº“ä¸­
        form.on('select(sourceCurrency)', function (data) {
            //è·å–æºè´§å¸çš„id
            var sourceId = data.value;
            // è·å–ç›®æ ‡è´§å¸çš„id
            var targetId = $("#targetCurrency").val();
            //é‡è½½æ•°æ®
            tableReloadmethod(sourceId, targetId);
            //é€šè¿‡2ä¸ªidå›å»æŸ¥
            $.post('/FinanceMgr/getRecordByRateId?sourceId=' + sourceId + '&targetId=' + targetId, {}, function (result) {
                if (result.obj) {
                    $("#rate").val(result.obj.exchangeRate);
                    $("#validTime").val(result.obj.startTimeValidShow + " -- " + result.obj.endTimeValidShow);
                } else {
                    $("#rate").val("");
                    $("#validTime").val("");
                }
            });
        });


        // è¡¨å•éªŒè¯
        form.verify({
            //æ•°ç»„çš„ä¸¤ä¸ªå€¼åˆ†åˆ«ä»£è¡¨ï¼š[æ­£åˆ™åŒ¹é…ã€åŒ¹é…ä¸ç¬¦æ—¶çš„æç¤ºæ–‡å­—]
            rateVerify: [
                /^\d+(\.\d{1,8})?$/
                , 'æ±‡ç‡æœ€å¤šæœ‰8ä½å°æ•°ï¼Œè¯·é‡æ–°è¾“å…¥ğŸ˜˜'
            ]
        });


        // è¡¨å•æäº¤ç”¨ajax
        form.on('submit(submit)', function (data) {
            layer.msg('æ‹œæ‰˜è¯·ç­‰ä¸€å“ˆï¼Œæ•°æ®å¯èƒ½æœ‰ç‚¹å¤šğŸ™ƒ', {
                icon: 16
                , shade: 0.01
                , time: 120 * 1000 // æœ€é•¿ç­‰å¾…120ç§’
            });
            $.ajax({
                url: "/FinanceMgr/saveCurrencyRate",
                data: data.field,
                type: "post",
                dataType: "json",
                success: function (result) {
                    layer.close(layer.index);
                    layer.open({
                        title: 'æç¤º'
                        , anim: 2
                        ,
                        content: result.success == false ? result.msg == null ? "æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•" : result.msg : result.msg
                        , yes: function () {
                            tableReloadmethod(data.sourceMonetary, data.targetMonetary);
                            layer.close(layer.index);
                        }
                    });
                }
            });
            return false;
        });
    });
</script>
</html>